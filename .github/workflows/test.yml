name: æµ‹è¯•
on:
  watch:
    types: [started]
  workflow_dispatch:

jobs:
  OpenWrt_Builder:
    runs-on: ubuntu-24.04-arm64
    timeout-minutes: 360
    if: github.actor == 'dfh1949'

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@latest
      with:
        fetch-depth: 0

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo -E apt update
        sudo -E apt -y full-upgrade
        sudo -E apt -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E systemctl daemon-reload
        sudo -E apt -y autoremove --purge
        sudo -E apt clean
        sudo -E timedatectl set-timezone "Asia/Shanghai"

    - name: æ£€æŸ¥ç©ºé—´
      run: df -hT

    - name: é‡Šæ”¾ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: å†æ¬¡æ£€æŸ¥ç©ºé—´
      run: df -hT

    - name: Clone OpenWrt master
      run: |
        git clone -b master --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"

    - name: æ›´æ–°å®‰è£…feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a  
        
    - name: æ£€æŸ¥å¹¶åº”ç”¨é…ç½®æ–‡ä»¶
      run: |
        cd openwrt
        echo "=============================="
        if [ -f ../config/diffconfig ]; then
          echo "âœ… å·²æ‰¾åˆ° config/defconfig"
          cp ../config/diffconfig .config
          make defconfig
        else
          echo "âš ï¸ æœªæ‰¾åˆ° config/diffconfigï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          make defconfig
        fi

        if [ -f ../config/kconfig ]; then
          echo "âœ… å·²æ‰¾åˆ° config/kconfig"
          cp ../config/kconfig target/linux/rockchip/armv8/config-6.12
        else
          echo "âš ï¸ æœªæ‰¾åˆ° config/kconfigï¼Œè·³è¿‡å†…æ ¸é…ç½®"
        fi
        echo "=============================="
        
    - name: è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
      run: |
        cd openwrt
        if [ -d ../files ]; then
          echo "âœ… æ£€æµ‹åˆ° files ç›®å½•ï¼Œå·²å¤åˆ¶"
          cp -r ../files .
        fi

    - name: Setup Ultra-Fast Toolchain
      run: |
        # Clang + mold ç¯å¢ƒå˜é‡
        export CC=clang
        export CXX=clang++
        export LD=mold           # ğŸ”¥ mold é“¾æ¥å™¨
        export AR=llvm-ar
        export NM=llvm-nm
        export STRIP=llvm-strip
        export OBJCOPY=llvm-objcopy
        export RANLIB=llvm-ranlib
        
        # mold ä¼˜åŒ–é…ç½®
        export RUSTFLAGS='-C link-arg=-fuse-ld=mold'
        
        # ccache è¶…çº§é…ç½®
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_COMPILERCHECK=content
        export CCACHE_MAXSIZE=4G
        export CCACHE_NODIRECT=1  # mold éœ€è¦æ­¤è®¾ç½®
        ccache -M 4G
        
    - name: ä¸‹è½½ä¾èµ–
      timeout-minutes: 60
      run: |
        cd openwrt
        export WGET_FLAGS="--tries=3 --timeout=30 --retry-connrefused --waitretry=5 --read-timeout=30"
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘
      timeout-minutes: 180
      run: |
        cd openwrt
        make -j4 V=s

    # æ£€æµ‹æ˜¯å¦ç¼–è¯‘æˆåŠŸ
    - name: æ£€æµ‹æ˜¯å¦ç¼–è¯‘æˆåŠŸ
      run: |
        ls openwrt/bin/targets/rockchip/armv8
        echo "ç¼–è¯‘å®Œæˆã€‚"

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å…¨éƒ¨
      uses: actions/upload-artifact@v4
      with:
       name: openwrt-firmware
       path: openwrt/bin/targets/rockchip/armv8/*
       retention-days: 30

    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
       name: openwrt-bin
       path: openwrt/bin/targets/rockchip/armv8/*.gz
       retention-days: 30
